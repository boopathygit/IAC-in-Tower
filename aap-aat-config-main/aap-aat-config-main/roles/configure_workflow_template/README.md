# configure_workflow_template

Ansible role for performing move / add / changes against Ansible Automation Platform (AAP) workflow job templates

## Requirements

Version: 2.9+

### Modules
  - ansible.controller | https://docs.ansible.com/ansible/latest/collections/awx/awx/index.html

## Variables

### Authentication

| Name                | Type   | Description                                   | Default           |
| ------------------- | ------ | --------------------------------------------- | ----------------- |
| controller_hostname | string | The host used for run role's tasks            | aap.ascension.org |
| controller_user     | string | Username for accessing controller_hostname    | null              |
| controller_pass     | string | Password for accessing controller_hostname    | null              |
| controller_token    | raw    | OAuth token for accessing controller_hostname | null              |

### Role-specific

| Name                      |       Type       | Description                                                                     | Default |
| ------------------------- | :--------------: | ------------------------------------------------------------------------------- | :-----: |
| job_config_secure_logging |     boolean      | whether to enable secure logging during role operation                          |  false  |
| job_config_ignore_errors  |     boolean      | whether to ignore errors during role operation                                  |  false  |
| async_config_retries      |     integer      | How many retries to use during async operation                                  |   30    |
| async_config_delay        |     integer      | How many seconds to wait between async retries                                  |    1    |
| workflow_templates        | list(dictionary) | A list of workflow job templates to configure within AAP. *See structure below* |   []    |

## Data Structure
### Workflow Job Template

| Name                             |       Type       | Description                                                                                                                                                                           | Choice / Default                                                                  |
| -------------------------------- | :--------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| name                             |      string      | Name to use for the workflow job template.                                                                                                                                            |                                                                                   |
| new_name                         |      string      | Setting this option will change the existing name (looked up via the name field).                                                                                                     |                                                                                   |
| copy_from                        |      string      | Name or id to copy the workflow job template from.<br><br>This will copy an existing workflow job template and change any parameters supplied.                                        |                                                                                   |
| description                      |      string      | Description to use for the workflow job template.                                                                                                                                     |                                                                                   |
| extra_vars                       |    dictionary    | Specify extra_vars for the workflow job template.                                                                                                                                     |                                                                                   |
| organization                     |      string      | Name of organization to associate with the workflow job template.                                                                                                                     |                                                                                   |
| inventory                        |      string      | Inventory applied as a prompt, assuming job template prompts for inventory.                                                                                                           |                                                                                   |
| limit                            |      string      | Limit applied as a prompt, assuming job template prompts for limit.                                                                                                                   |                                                                                   |
| labels                           |   list(string)   | The labels applied to this job template<br><br>Must be created with the labels module first. This will error if the label has not been created.                                       |                                                                                   |
| scm_branch                       |      string      | SCM branch applied as a prompt, assuming workflow job template prompts for SCM branch.                                                                                                |                                                                                   |
| allow_simultaneous               |     boolean      | Allow simultaneous runs of the workflow job template.                                                                                                                                 | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| ask_variables_on_launch          |     boolean      | Prompt for extra_vars on launch.                                                                                                                                                      | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| ask_inventory_on_launch          |     boolean      | Prompt for inventory on launch. `inventory` will be used if specified.                                                                                                                | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| ask_scm_branch_on_launch         |     boolean      | Prompt for scm branch on launch. `scm_branch` will be used if specified.                                                                                                              | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| ask_limit_on_launch              |     boolean      | Prompt for inventory limit on launch. `limit` will be used if specified.                                                                                                              | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| webhook_service                  |      string      | Service that webhook requests will be accepted from.                                                                                                                                  |                                                                                   |
| webhook_credential               |      string      | Personal Access Token for posting back the status to the service API                                                                                                                  |                                                                                   |
| survey_enabled                   |     boolean      | Enable a survey on the job template.                                                                                                                                                  | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| survey_spec                      |    dictionary    | JSON/YAML dict formatted survey definition.                                                                                                                                           | ""                                                                                |
| schema                           | list(dictionary) | JSON/YAML list of nodes and their coresponding options. *See structure below*                                                                                                         | ""                                                                                |
| simplfied_schema                 | list(dictionary) | JSON/YAML list of nodes and their coresponding options. *See structure below*<br><br>NOTE: </quote>                                                                                   | ""                                                                                |
| destroy_current_schema           |     boolean      | Set in order to destroy current schema on the workflow.<br><br>This option is used for full schema update. If not used, and schema or nodes is defined, the schema will be destroyed. | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| notification_templates_started   |   list(string)   | list of notifications to send on start.                                                                                                                                               |                                                                                   |
| notification_templates_success   |   list(string)   | list of notifications to send on success.                                                                                                                                             |                                                                                   |
| notification_templates_error     |   list(string)   | list of notifications to send on error.                                                                                                                                               |                                                                                   |
| notification_templates_approvals |   list(string)   | list of notifications to send on approvals.                                                                                                                                           |                                                                                   |
| verbosity                        |      string      | Verbosity applied as a prompt, if workflow job template prompts for verbosity.                                                                                                        | **CHOICES**:<ul><li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li></ul> |
| state                            |      string      | Desired state of the workflow job template.                                                                                                                                           | **CHOICES**:<ul><li>**present**</li><li>absent</li></ul>                          |

#### Workflow Job Template - Schema

> This option is applicable if you want granular control over the workspace node. This is more complicated, but it allows for faster operation
>
> `simplified_schema` is available for a more generalized, albeit slower, configuration of workflow job templates.

| Name                      | Sub-Option    |    Type    | Description                                                                                                                                                                                                                                                                                       | Choice / Default                                                                  |
| ------------------------- | ------------- | :--------: | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| all_parents_must_converge |               |  boolean   | If enabled then the node will only run if all of the parent nodes have met the criteria to reach this node                                                                                                                                                                                        | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |
| diff_mode                 |               |  boolean   | Run diff mode, applied as a prompt, if job template prompts for diff mode                                                                                                                                                                                                                         | **CHOICES**:<ul><li>true</li><li>false</li></ul>                                  |  |
| extra_data                |               | dictionary | Variables to apply at launch time.<br><br>Will only be accepted if job template prompts for vars or has a survey asking for those vars.                                                                                                                                                           | `{}`                                                                              |
| identifier                |               |   string   | An identifier for this node that is unique within its workflow.<br><br>It is copied to workflow job nodes corresponding to this node.                                                                                                                                                             |                                                                                   |
| inventory                 |               |   string   | Inventory applied as a prompt, if job template prompts for inventory.                                                                                                                                                                                                                             |                                                                                   |
| job_tags                  |               |   string   | Job tags applied as a prompt, if job template prompts for job tags.                                                                                                                                                                                                                               |                                                                                   |
| skip_tags                 |               |   string   | Tags to skip, applied as a prompt, if job template prompts for job tags.                                                                                                                                                                                                                          |                                                                                   |
| job_type                  |               |   string   | Job type applied as a prompt, if job template prompts for job type.                                                                                                                                                                                                                               | **CHOICES**:<ul><li>run</li><li>check</li></ul>                                   |
| limit                     |               |   string   | Limit to act on, applied as a prompt, if job template prompts for limit.                                                                                                                                                                                                                          |                                                                                   |
| scm_branch                |               |   string   | SCM branch applied as a prompt, if job template prompts for SCM branch.                                                                                                                                                                                                                           |                                                                                   |
| related                   |               | dictionary | Related items to this workflow node.<br><br>Must include credentials, failure_nodes, always_nodes, success_nodes, even if empty.                                                                                                                                                                  |                                                                                   |
| related                   | always_nodes  |    list    | Nodes that will run after this node completes.<br><br>List of node identifiers.<br><br>NOTE: Nested value is `identifier`</quote>                                                                                                                                                                 |                                                                                   |
| related                   | failure_nodes |    list    | Nodes that will run after this node on failure.<br><br>List of node identifiers.<br><br>NOTE: Nested value is `identifier`</quote>                                                                                                                                                                |                                                                                   |
| related                   | success_nodes |    list    | Nodes that will run after this node on success.<br><br>List of node identifiers.<br><br>NOTE: Nested value is `identifier`</quote>                                                                                                                                                                |                                                                                   |
| related                   | credentials   |    list    | Credentials to be applied to job as launch-time prompts.<br><br>List of credential names.<br><br>Uniqueness is not handled rigorously.<br><br>NOTE: Nested value is `name`                                                                                                                        |                                                                                   |
| unified_job_template      |               | dictionary | Name of unified job template to run in the workflow.<br><br>Can be a job template, project sync, inventory source sync, etc.<br><br>Omit if creating an approval node (not yet implemented).                                                                                                      |                                                                                   |
| unified_job_template      | description   |   string   | Optional description of this workflow approval template.                                                                                                                                                                                                                                          |                                                                                   |
| unified_job_template      | inventory     | dictionary | Name of key for use in model for organizational reference<br><br>Only Valid and used if referencing an inventory sync.<br><br>This parameter is mutually exclusive with suboption `organization`<br><br>NOTE: Nested value is dictionary `organization` with an expected option of `name`</quote> |                                                                                   |
| unified_job_template      | name          |   string   | Name of unified job template to run in the workflow.<br><br>Can be a job template, project, inventory source, etc.                                                                                                                                                                                |                                                                                   |
| unified_job_template      | organization  | dictionary | Name of key for use in model for organizational reference<br><br>Only Valid and used if referencing a job template or project sync<br><br>This parameter is mutually exclusive with suboption `inventory`. NOTE: Nested value is `name`</quote>                                                   |                                                                                   |
| unified_job_template      | timeout       |  integer   | The amount of time (in seconds) to wait before Approval is canceled. A value of 0 means no timeout.<br><br>Only valid and used if referencing an Approval Node                                                                                                                                    |                                                                                   |
| unified_job_template      | type          |   string   | Name of unified job template type to run in the workflow.<br><br>Can be a job_template, project, inventory_source, workflow_approval.                                                                                                                                                             |                                                                                   |
| verbosity                 |               |   string   | Verbosity applied as a prompt, if workflow job template prompts for verbosity.                                                                                                                                                                                                                    | **CHOICES**:<ul><li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li></ul> |
| state                     |               |   string   | Desired state of the workflow job template node.                                                                                                                                                                                                                                                  | **CHOICES**:<ul><li>**present**</li><li>absent</li></ul>                          |

#### Workflow Job Template - Simplified Schema

> This option allows for a more generalize configuration of workflow nodes.
>
> This method leverages [ansible.controller.workflow_job_template_node](https://docs.ansible.com/ansible/latest/collections/awx/awx/workflow_job_template_node_module.html#ansible-collections-awx-awx-workflow-job-template-node-module) to create the workflow node resources.

| Name                      | Sub-Option  |     Type     | Description                                                                                                                                                                                                                   | Choice / Default                                                                  |
| ------------------------- | ----------- | :----------: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------- |
| identifier                |             |    string    | An identifier for this node that is unique within its workflow.<br><br>It is copied to workflow job nodes corresponding to this node.                                                                                         |                                                                                   |
| workflow_job_template     |             |    string    | The workflow job template the node exists in. Used for looking up the node, cannot be modified after creation.                                                                                                                | *injected as part of the workflow_templates list / dictionary*                    |
| extra_data                |             |  dictionary  | Variables to apply at launch time.<br><br>Will only be accepted if job template prompts for vars or has a survey asking for those vars.                                                                                       | `[]`                                                                              |
| inventory                 |             |    string    | Inventory applied as a prompt, if job template prompts for inventory.                                                                                                                                                         | `""`                                                                              |
| scm_branch                |             |    string    | SCM branch applied as a prompt, if job template prompts for SCM branch.                                                                                                                                                       | `""`                                                                              |
| job_type                  |             |    string    | Job type applied as a prompt, if job template prompts for job type.                                                                                                                                                           | **CHOICES**:<ul><li>run</li><li>check</li></ul>                                   |
| job_tags                  |             |    string    | Job tags applied as a prompt, if job template prompts for job tags.                                                                                                                                                           | `""`                                                                              |
| skip_tags                 |             |    string    | Tags to skip, applied as a prompt, if job tempalte prompts for job tags.                                                                                                                                                      | `""`                                                                              |
| limit                     |             |    string    | Limit to act on, applied as a prompt, if job template prompts for limit.                                                                                                                                                      | `""`                                                                              |
| diff_mode                 |             |   boolean    | Run diff mode, applied as a prompt, if job template prompts for diff mode.                                                                                                                                                    | `""`                                                                              |
| verbosity                 |             |    string    | Verbosity applied as a prompt, if job template prompts for verbosity.                                                                                                                                                         | **CHOICES**:<ul><li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li></ul> |
| credentials               |             | list(string) | Credentials to be applied to job as launch-time prompts.<br><br>List of credential names.<br><br>Uniqueness is not handled rigorously.                                                                                        | `[]`                                                                              |
| unified_job_template      |             |    string    | Name of unified job template to run in the workflow.<br><br>Can be a job template, project, inventory source, etc.<br><br>Omit if creating an approval node.<br><br>This parameter is mutually exclusive with `approval_node` | `""`                                                                              |
| approval_node             |             |  dictionary  | A dictionary of Name, description, and timeout values for the approval node.<br><br>This parameter is mutually exclusive with `unified_job_template`.                                                                         | `""`                                                                              |
| approval_node             | name        |    string    | Name of this workflow approval template.                                                                                                                                                                                      | `required if approval_node is used`                                               |
| approval_node             | description |    string    | Optional description of this workflow approval template.                                                                                                                                                                      | `""`                                                                              |
| approval_node             | timeout     |   integer    | The amount of time (in seconds) before the approval node expires and fails.                                                                                                                                                   | `""`                                                                              |
| always_nodes              |             | list(string) | Nodes that will run after this node completes.<br><br>List of node identifiers.                                                                                                                                               | `[]`                                                                              |
| success_nodes             |             | list(string) | Nodes that will run after this node on success.<br><br>List of node identifiers.                                                                                                                                              | `[]`                                                                              |
| failure_nodes             |             | list(string) | Nodes that will run after this node on failure.<br><br>List of node identifiers.                                                                                                                                              | `[]`                                                                              |
| all_parents_must_converge |             |   boolean    | If enabled then the node will only run if all of the parent nodes have met the criteria to reach this node.                                                                                                                   | **CHOICES**:<ul><li>true</li><li>**false**</li></ul>                              |
| organization              |             |    string    | The organization of the workflow job template the node exists in.<br><br>Used for looking up the workflow, not a direct model field.                                                                                          | `"AscTech"`                                                                       |
| state                     |             |    string    | Desired state of the workflow job template node.                                                                                                                                                                              | **CHOICES**:<ul><li>**present**</li><li>absent</li></ul>                          |

## Dependencies

- Read/Write access to target AAP organization
- Username / password OR Token access to AAP
- HTTPS access to AAP

## Example Playbook

```yaml
---
- hosts: localhost

  vars_files:
    - workflows.yml

  roles:
    - role: configure_workflow_template
```

## Additional Notes

N/A